---
title: "Data analysis project"
author: "Jess Qualley and Rebecca Hansen"
date: "March 27, 2020"
output: word_document
---

##Clear code (**delete before submitting***)
```{r}
rm(list = ls(all = TRUE))
```

#Preparation
##Loading and citing packages
```{r, echo = TRUE}
#Load faraway package
library(faraway)

#Load plyr package
library(plyr)

#Load tidyverse package
library(tidyverse)

#Load lmer package
library(lme4)

#Cite packages
citation("faraway")
citation("plyr")
citation("tidyverse")
```

##Read in and organize data
```{r, echo = TRUE}
#Read from csv file
herring <- read.csv("HerringOtolithDatabase 15 Jan 2020_JQ.csv", header=TRUE, fileEncoding="UTF-8-BOM", stringsAsFactors = FALSE)

#Create a data frame
herring_data <- data.frame(sal.id = herring$FishCode,
                           oto.width = herring$AverageWidth,
                           sal.sp = herring$SalmonSpecies,
                           sal.length = (herring$SalmonLength),
                           coll.year = herring$CollectionYear,
                           coll.doy =   herring$CollectionDayofYear,
                           lat = herring$Latitude,
                           long = herring$Longitude,
                           stat.area = as.factor(herring$StatArea))

#figure out which stat areas to remove
levels(as.factor(herring$StatArea))

#filter for 2018 data, chinook salmon only, omit northern BC areas (Haid Gwaii) and west coast Vancouver Island
herring_data <- herring_data %>% filter(herring_data$sal.sp == "ch" & herring_data$coll.year == "2018" & herring_data$stat.area != "1" & herring_data$stat.area != "101" & herring_data$stat.area != "125" & herring_data$stat.area != "23" & herring_data$stat.area != "25")

```


#Section 1: Introduction, Question, Goals and Hypotheses (400 words)
##A)
Introduce relevant concepts: 
- State of salmon in BC
- Salmon diet
- Herring as a prey item for salmon
- Gape size theory
- Yearly availbaility of herring of different sizes
- Regional differences

How the dataset was collected:
- Salmon stomachs donated to Juanes lab by anglers
- Salmon stomach contents sorted and classfied based on digestion
- Otoliths collected and measured

 Background needed to understand the dataset:
- Otolith width as the best proxy for herring length

At least two scientiﬁc papers that are related to your topic:

##B)
Research question:
- What physiological, environmental and temporal factors determine the size of herring eaten by Chinook salmon in the Salish Sea

##C)
Goal of research: 
- Description, because we want to know what variables best explain the patterns in the size of herring eaten by Chinook salmon 

##D)
Hypothesis:
- Salmon Length: Positive non-linear relationship, logarithmic curve where asymptote is maximum herring size
- Collection day of year: Non-linear, positive quadratic function where vertex is midway through the year
- latitude: linear, positive relationship with increasing latitude
- longitude: non-linear, positive quadratic function where the vertex occurs at mid-channel points longitudinally through the Strait of Georgia Channel...
- salmon id: no relationship
-interactions: ? 


##E)
Model selection:
- We want to determine what factors explain patterns in the size of herring eaten by salmon 
- So we want to choose a model which best describes this pattern
- Our possible models are not nested, we aren't testing a null model
- We have a fairly small sample size
- Use the AICc

#Section 2: The Response Variable (150 words)
##A)
```{r, echo = TRUE}
#Add column for number of rows
n <- nrow(herring_data)
herring_data$row <- 1:n

#Dotchart of otolith width (response variable)
with(herring_data, plot(oto.width, row, las = 1, type = "n", xlab = "Otolith width [mm]", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(oto.width, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Histogram of response variable with rugmarks
hist(herring_data$oto.width, xlim = c(0.3, 2.8), breaks = seq(0.2, 2.8, by = 0.05), col = grey(0.9), main = "Histogram of herring otolith width", xlab = "Herring otolith width")
rug(herring_data$oto.width)

#Checking for zeroes and NAs in otilith width
table(herring_data$oto.width > 0, useNA = "always")

#exclude rows with NAs for continuous variables
herring_data <- herring_data %>% na.omit()

```

##B) 
Qualitative description of response variable:
- Continuous 
- Bounded by 0, can't take negative values

##C)
Potential issues with response variable
- Intially no zeroes and one missing value
- We removed the single NA value for all subsequent analyses - this was a vial with a missing/lost otolith pair - expect no difficulties omitting this NA value (say something about salmon length?)
- Outliers at > 2.2 mm and < 0.6 mm, but they're biologically reasonable and could represent a few individuals at extreme age classes
- Non-independence is expected from repeated measurements of multiple herring that occurred within the same salmon stomach/experimental unit. It is likely that similar sized herring will occur in the same school targeted by a salmon.

- We expect non-idependence of herring size both from temporal and spatial autocorrelation. Sources of temporal autocorrelation could be that herring consumed by salmon at the same time of year have similar growth trajectories. Sources of spatial autocorrelation of herring size may include the fact that herring in a similar area have similar feeding resources and grow rates in addition to smaller fish that occur closer to subtidal habitats compared to larger fish that occur in deeper, pelagic habitats which may contribute to spatial autocorrelation.

##D)
Candidate distributions for variable
- We are most likely to use the normal distribution. While the distribution is bound by 0 we have continuous data values (non-integer) and it is mostly symmetrical around the mean.

#Section 3: The Explanatory Variables (150 words)
##A)
###Continuous explanatory variables
```{r, fig.width = 6,fig.height = 6}
#Multipanel of dotcharts for continuous explanatory variables
par(mfrow = c(3, 2))

#Salmon length
with(herring_data, plot(sal.length, row, las = 1, type = "n", xlab = "Actual Salmon Length [mm]", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(sal.length, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Collection day of year
with(herring_data, plot(coll.doy, row, las = 1, type = "n", xlab = "Day of Year in 2018", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(coll.doy, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Latitude
with(herring_data, plot(lat, row, las = 1, type = "n", xlab = "Latitude", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(lat, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Longitude
with(herring_data, plot(long, row, las = 1, type = "n", xlab = "Longitude", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(long, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Multipanel of histograms for continuous explanatory variables
par(mfrow = c(3, 2))

#Salmon length
hist(herring_data$sal.length, col = grey(0.9), breaks = seq(40, 100, by = 1), main = "Histogram of salmon length", xlab = "Salmon length")
rug(herring_data$sal.length)

#Collection day of year
hist(herring_data$coll.doy, col = grey(0.9), breaks = seq(0, 400, by = 7), main = "Histogram of day of year", xlab = "Collection day of year")
rug(herring_data$coll.doy)

#Latitude *something is up with this y axis
hist(herring_data$lat, col = grey(0.9), breaks = seq(48.0, 51.0, by = 0.05), main = "Histogram of latitude", xlab = "Latitude")
rug(herring_data$lat)

#Longitude
hist(herring_data$long, col = grey(0.9), breaks = seq(-125.5, -123, by = 0.05), main = "Histogram of longitude", xlab = "Longitude")
rug(herring_data$long)

```

###Categorical explanatory variables
```{r, fig.width = 6,fig.height = 4}
#Make a histogram of salmon id vs digestion
hist(herring_data$sal.id, col = grey(0.9), breaks = seq(17300, 18200, by = 1), main = "Histogram of Salmon ID", xlab = "Salmon ID")

#Multipanel of dotcharts for categorical explanatory variables
par(mfrow = c(2, 2))

#Salmon id
with(herring_data, plot(sal.id, row, las = 1, type = "n", xlab = "Salmon ID", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(sal.id, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Digestion
with(herring_data, plot(digestion, row, las = 1, type = "n", xlab = "Digestion state", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(digestion, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Collection Month
with(herring_data, plot(coll.month, row, las = 1, type = "n", xlab = "Collection Month", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(coll.month, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Salmon sex (note - label the first categorical NA variable)
with(herring_data, plot(sal.sex, row, las = 1, type = "n", xlab = "Salmon sex", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(sal.sex, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Tables for categorical explanatory variables
#Make a table of salmon sex versus collection month
with(herring_data, table(sal.sex, coll.month))

#Make a table of salmon sex versus digestion
with(herring_data, table(sal.sex, digestion))

#Make a table of collection month versus digestion
with(herring_data, table(coll.month, digestion))
```

##B)
- Outliers - For the continuous explanatory variable salmon length, there is one outlier at 45cm and three outliers between 90-100cm; however, these are reasonable sizes for recreationally caught chinook salmon. While not considered outliers, there are few larger salmon that have large weights. 
- Transformations why or why not? We may want to transform weight and length as they appear slightly right-skewed. **note: we must decide this later.

#Section 4: Collinearity, Balance, and Variance Inﬂation Factors (200 words)
##A)
```{r, echo = TRUE}
#create data frame for pairwise scatter with only continuous explanatory variables - salmon lenght, weight, collection day of year, latitude and longitude
herring_collinearity <- data.frame("sal.length" = herring_data$sal.length, "sal.weight" = herring_data$sal.weight, "coll.doy" = herring_data$coll.doy, "coll.month" = herring_data$coll.month, "lat" = herring_data$lat, "long" = herring_data$long)

#Pairwise scatterplot of explanatory variables (salmon length, weight, day of year, latitude and longitude)
plot(herring_collinearity[1:6], cex = 0.5, pch = 19, col = rgb(0, 0, 0, 0.5), 
                   labels = c("Chinook\nLength [mm]", "Chinook\nWeight [lbs]", "Collection\nDay in 2018", "Collection\nMonth in 2018", "Latitude", "Longitude"))

#Pairwise correlation coefficients for explanatory variables
print(cor(na.omit(herring_data[ ,c("sal.length", "sal.weight", "coll.doy", "lat", "long")])), digits = 2)

#Variance Inflation Factors
print(vif(na.omit(herring_data[ ,c("sal.length", "sal.weight", "coll.doy", "lat", "long")])))

#Balance of dataset (if appropriate)

```
Comment on balance - Referring to tables in section 3: we observe more salmon samples collected between March(3) to July(7) compared to other months and there are more females than males, although there is a high number of unsexed fish in this dataset. There is a higher number of herring categorized as digestion level 2, 3 and 4 compared to level 1. The difficulties we may encounter is to include sex if only 2/3 of the fish are sexed, therefore, it will be harder to evaluate whether sex is a useful predictor or not. The unbalanced nature of temporal sampling, it will be harder to evaluate the relationship during winter months. There isn't simultaneous unbalancing across multiple variables, we only see holes, so this is less likely to be confounding but rather limiting in making any generalized conclusions about how sex and the winter period relates to herring size consumed by salmon.

Comment on pairwise scatterplots - there is a strong positive relationship between Chinook length and weight (0.91) in addition to a strong positive relationship between collection day in 2018 and collection month in 2018. While there isn't an obvious linear relationship between salmon length and weigth vs collection day and collection month, there is evidence for a concave up relationship between collection day of year and collection day of month with length and weight, perhaps due to seasonality of salmon caught during the spring and summer months. There is a strong positive relationship between collection day and collection month which is expected since collection month is pooled data of collection day. There is a strong negative relationship between latitude and longitude (-0.83).

Comment on VIFs - The VIF values of salmon length (6.818335), weight (6.932405), latitude (3.954376) and longitude (3.823013) are greater than 3 and therefore strongly colinear.

Comment on potential difficulties from correlations and benefits - the difficulty will be including both length and weight, both latitude and longitute and both month and day of year in our statistical models. We would want to include either length or weight, either latitude or longitude and either month or day of year, so that they don't confound each other. Seasonality in salmon size (length and weigth) may confound the relationship between these two variables.

#Section 5: Statistical Methods and Model Fitting (200 words)
Statistical methods
- Which you will use and why
- Cite packages used for modelling
- What family of probability distributions (what link function)
- Which explantory variables are we including
- If and why data points are excluded
- If transformations are used and why
- If random-effects are used and why

Models

1. sal.id + doy + long + length + digestion
2. sal.id + doy + long + length
3. sal.id + doy + long + weight + digestion
4. sal.id + doy + long + weight
5. sal.id + doy + lat + length + digestion
6. sal.id + doy + lat + length
7. sal.id + doy + lat + weight + digestion
8. sal.id + doy + lat + weight

9. sal.id + month + long + length + digestion
10. sal.id + month + long + length
11. sal.id + month + long + weight + digestion
12. sal.id + month + long + weight
13. sal.id + month + lat + length + digestion
14. sal.id + month + lat + length
15. sal.id + month + lat + weight + digestion
16. sal.id + month + lat + weight

##Exploratory plotting
```{r, echo = TRUE}
#Sal.ID
plot(oto.width ~ sal.id, data = herring_data)

#Sal.length
plot(oto.width ~ sal.length, data = herring_data)

#Sal.weight
plot(oto.width ~ sal.weight, data = herring_data)

#Sal.length.trans
plot(oto.width ~ sal.length.trans, data = herring_data)

#Sal.weight.trans
plot(oto.width ~ sal.weight.trans, data = herring_data)

#Coll.month
plot(oto.width ~ coll.month, data = herring_data)

#Coll.doy
plot(oto.width ~ coll.doy, data = herring_data)

#Lat
plot(oto.width ~ lat, data = herring_data)

#Long
plot(oto.width ~ long, data = herring_data)




```
##Untransformed models
```{r, echo = TRUE}
herring_data <- herring_data %>% filter(coll.month == "3" | coll.month == "4" | coll.month == "5" | coll.month == "6" | coll.month == "7")

#Fit model 1
model_1 <- lmer(oto.width ~ coll.month + long + sal.length + digestion + (1|sal.id), data = herring_data)

#Fit model 2
model_2 <- lmer(oto.width ~ coll.month + long + sal.length + (1|sal.id), data = herring_data)

#Fit model 3
model_3 <- lmer(oto.width ~ coll.month + long + sal.weight + digestion + (1|sal.id), data = herring_data)

#Fit model 4
model_4 <- lmer(oto.width ~ coll.month + long + sal.weight + (1|sal.id), data = herring_data)

#Fit model 5
model_5 <- lmer(oto.width ~ coll.month + lat + sal.length + digestion + (1|sal.id), data = herring_data)

#Fit model 6
model_6 <- lmer(oto.width ~ coll.month + lat + sal.length + (1|sal.id), data = herring_data)

#Fit model 7
model_7 <- lmer(oto.width ~ coll.month + lat + sal.weight + digestion + (1|sal.id), data = herring_data)

#Fit model 8
model_8 <- lmer(oto.width ~ coll.month + lat + sal.weight + (1|sal.id), data = herring_data)

#Fit model 9
model_9 <- lmer(oto.width ~ coll.doy + long + sal.length + digestion + (1|sal.id), data = herring_data)

#Fit model 10
model_10 <- lmer(oto.width ~ coll.doy + long + sal.length + (1|sal.id), data = herring_data)

#Fit model 11
model_11 <- lmer(oto.width ~ coll.doy + long + sal.weight + digestion + (1|sal.id), data = herring_data)

#Fit model 12
model_12 <- lmer(oto.width ~ coll.doy + long + sal.weight + (1|sal.id), data = herring_data)

#Fit model 13
model_13 <- lmer(oto.width ~ coll.doy + lat + sal.length + digestion + (1|sal.id), data = herring_data)

#Fit model 14
model_14 <- lmer(oto.width ~ coll.doy + lat + sal.length + (1|sal.id), data = herring_data)

#Fit model 15
model_15 <- lmer(oto.width ~ coll.doy + lat + sal.weight + digestion + (1|sal.id), data = herring_data)

#Fit model 16
model_16 <- lmer(oto.width ~ coll.doy + lat + sal.weight + (1|sal.id), data = herring_data)
```

#Section 6: Model Checking 
##All models summarized (delete before submitting?)
```{r, echo = TRUE}
#Summary of model 1
summary_1 <- summary(model_1)$coef

#Summary of model 2
summary_2 <- summary(model_2)$coef

#Summary of model 3
summary_3 <- summary(model_3)$coef

#Summary of model 4
summary_4 <- summary(model_4)$coef

#Summary of model 5
summary_5 <- summary(model_5)$coef

#Summary of model 6
summary_6 <- summary(model_6)$coef

#Summary of model 7
summary_7 <- summary(model_7)$coef

#Summary of model 8
summary_8 <- summary(model_8)$coef

#Summary of model 9
summary_9 <- summary(model_9)$coef

#Summary of model 10
summary_10 <- summary(model_10)$coef

#Summary of model 11
summary_11 <- summary(model_11)$coef

#Summary of model 12
summary_12 <- summary(model_12)$coef

#Summary of model 13
summary_13 <- summary(model_13)$coef

#Summary of model 14
summary_14 <- summary(model_14)$coef

#Summary of model 15
summary_15 <- summary(model_15)$coef

#Summary of model 16
summary_16 <- summary(model_16)$coef

```


##All models plotted against data (delete before submitting?)
```{r, echo = TRUE}
#Plot model 1 residuals
plot(model_1, which = 1)

#Plot model 2 residuals
plot(model_2, which = 1)

#Plot model 3 residuals
plot(model_3, which = 1)

#Plot model 4 residuals
plot(model_4, which = 1)

#Plot model 5 residuals
plot(model_5, which = 1)

#Plot model 6 residuals
plot(model_6, which = 1)

#Plot model 7 residuals
plot(model_7, which = 1)

#Plot model 8 residuals
plot(model_8, which = 1)

#Plot model 9 residuals
plot(model_9, which = 1)

#Plot model 10 residuals
plot(model_10, which = 1)

#Plot model 11 residuals
plot(model_11, which = 1)

#Plot model 12 residuals
plot(model_12, which = 1)

#Plot model 13 residuals
plot(model_13, which = 1)

#Plot model 14 residuals
plot(model_14, which = 1)

#Plot model 15 residuals
plot(model_15, which = 1)

#Plot model 16 residuals
plot(model_16, which = 1)
```

##All transformed models plotted against data (delete before submitting?)
```{r, echo = TRUE}
#Plot model 1t residuals
plot(model_1t, which = 1)

#Plot model 2t residuals
plot(model_2t, which = 1)

#Plot model 3t residuals
plot(model_3t, which = 1)

#Plot model 4t residuals
plot(model_4t, which = 1)

#Plot model 5t residuals
plot(model_5t, which = 1)

#Plot model 6t residuals
plot(model_6t, which = 1)

#Plot model 7t residuals
plot(model_7t, which = 1)

#Plot model 8t residuals
plot(model_8t, which = 1)

#Plot model 9t residuals
plot(model_9t, which = 1)

#Plot model 10t residuals
plot(model_10t, which = 1)

#Plot model 11t residuals
plot(model_11t, which = 1)

#Plot model 12t residuals
plot(model_12, which = 1)

#Plot model 13t residuals
plot(model_13t, which = 1)

#Plot model 14t residuals
plot(model_14t, which = 1)

#Plot model 15t residuals
plot(model_15t, which = 1)

#Plot model 16t residuals
plot(model_16t, which = 1)
```
##Chosen models
```{r, echo = TRUE}
#Check the assumptions of at least one model
#-  plotting and interpreting the residuals of the model
#-  check for correlation in the residuals due to grouping variables

```

Summary of the plausibility of the model
- Potential outliers

#Section 7: Model Summary, Conﬁdence Intervals and Model Comparison 

```{r, echo = TRUE}
#Model comparison and/or model selection and/or hypothesis testing
#- AIC (or AICc) values
#- AIC (or AICc) weights
#- R-squared (or adjusted R-squared) values
#- p-values. 
#Summary for at least one ﬁtted model
#- coeﬃcient estimates and their standard errors
#- conﬁdence intervals for coeﬃcient estimate
```

#Section 8: Plotting a Model with the Data

```{r, echo = TRUE}
#Plot at least one model with data
#- use method that shows strengths and weaknesses
#- include measurement of uncertainty
```

#Section 9: Discussion (400 words)
##A)
Assessment of how well the model seems to ﬁt the data
- model checking
- visualization of the model with the data
- 
##B)
Qualitative interpretation of the model
- interpretation of results in relation to your research questions and hypotheses
- general interpretation of conﬁdence intervals or standard errors for coeﬃcient estimates
-
##C)
Limitations of the model(s) that you have ﬁt
- Limitations
- Possible options for improvement
- Possible approaches for further data analysis

##D)
Results into context
- citie at least two relevant scientiﬁc papers