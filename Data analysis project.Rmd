---
title: "Data Analysis Project"
author: "Jess Qualley and Rebecca Hansen"
date: "April 06, 2020"
output: word_document
---
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Load faraway package
library(faraway)

#Load plyr package
library(plyr)

#Load tidyverse package
library(tidyverse)

#Load gridextra package
library(gridExtra)

#Load lmer package
library(lme4)

#Load bbmle package
library(bbmle)
```

## Read in and organize data
```{r, echo = TRUE}
#Read from csv file
herring <- read.csv("HerringOtolithDatabase 15 Jan 2020_JQ.csv", header=TRUE, fileEncoding="UTF-8-BOM", stringsAsFactors = FALSE)

#Create a data frame
herring_data <- data.frame(oto.width = herring$AverageWidth,
                           sal.id = herring$FishCode,
                           sal.length = herring$SalmonLength,
                           coll.doy = herring$CollectionDayofYear,
                           lat = herring$Latitude,
                           long = herring$Longitude,
                           coll.month = herring$CollectionMonth,
                           
                           sal.sp = herring$SalmonSpecies,
                           coll.year = herring$CollectionYear,
                           stat.area = as.factor(herring$StatArea))

#Filter for 2018 chinook salmon only, omit northern BC areas (Haid Gwaii) and west coast Vancouver Island
herring_data <- herring_data %>% filter(herring_data$sal.sp == "ch" & herring_data$coll.year == "2018" & herring_data$stat.area != "1" & herring_data$stat.area != "101" & herring_data$stat.area != "125" & herring_data$stat.area != "23" & herring_data$stat.area != "25")
```

# Section 1: Introduction, Question, Goals and Hypotheses
## A)
Pacific Salmon in British Columbia are valued for their social, cultural and economic benefits to many communities on our coast. Despite their important role in the coastal marine ecosystem (Schindler et al. 2003), diet studies from this region are outdated and limited to summer sampling. The adult Chinook and Coho Salmon Diet Program (Juanes Lab) seeks to address these knowledge gaps by sourcing stomach samples from the recreational fishing community to gather regional, seasonal and interannual diet data to monitor ecosystem response to environmental change.

Pacific Herring are the dominant fish consumed throughout regions of the Salish Sea, year-round. For this project we will investigate factors that may be important to the size of herring consumed by Chinook Salmon. Previous work found a positive, linear relationship between otolith width (mm) and length (mm) of herring from this dataset. Otolith width (mm) measurements averaged from left and right otoliths will be used as a proxy for herring size (Stevenson and Campana, 1992) in this analysis. We will use salmon catch data recorded by each angler and linked to each stomach sample.

## B)
How does Chinook size, catch location and time of year in the Salish Sea affect the size of herring prey consumed?

## C)
This analysis is descriptive, with the goal of showing how explanatory variables describe patterns in herring size consumed by Chinook.

## D)
We hypothesize that otolith width will be positively linear with salmon length and collection day of year. We expect a moderately positive, linear relationship with increasing latitude and negative linear relationship with longitude if larger herring occur along western Strait of Georgia. A non-linear relationship with longitude is possible if maximum herring size occurrs in mid-channel waters. We expect an interaction between salmon length and latitude, because of higher productivity in northern regions. An interaction between salmon length and longitude is possible if mainland and Vancouver Island stocks differ in size. We expect an interaction between salmon length and day of year as each age class grows.

## E)
We will use AIC fit with maximum likelihood estimation because it is flexible when comparing complex, non-nested models with parameters estimated from ecological field studies. AIC is commonly used in ecosystem studies where parameter estimates are relatively imprecise and we accept that the optimal model may be selected over the true model, given the current sample size and our ecological understanding of the system. (396)

# Section 2: The Response Variable (150 words)
## A)
```{r, fig.width = 10, fig.height = 5, echo = FALSE}
#Make multipanel plot
par(mfrow = c(1, 2))

#Add column for number of rows
n <- nrow(herring_data)
herring_data$row <- 1:n

#Make dotchart of otolith width (response variable)
with(herring_data, plot(oto.width, row, las = 1, type = "n", cex.main = 1.5, cex.lab = 1.5, cex.axis = 1, xlab = "Otolith width [mm]", ylab = "Row Number", main = "Dotchart of otolith width"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(oto.width, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Make histogram of response variable with rugmarks
hist(herring_data$oto.width, cex.main = 1.5, cex.lab = 1.5, cex.axis = 1.5, xlim = c(0.3, 2.8), breaks = seq(0.2, 2.8, by = 0.05), col = grey(0.9), main = "Histogram of otolith width", xlab = "Otolith width [mm]")
rug(herring_data$oto.width)
```

```{r}
#Check for zeroes and NAs in otilith width
table(herring_data$oto.width > 0, useNA = "always")

#Exclude rows with NAs for continuous variables
herring_data <- herring_data %>% na.omit()
```

## B) 
The response variable (otolith width) is continuous and cannot take on zero or negative values. The range of possible response values in this dataset is 0.007 mm to 2.68 mm. 

## C)
Outliers at < 0.6 mm and > 2.2 mm are reasonable measurements representing a few individuals in the extreme size classes. There are no zero values and one missing otolith measurement making up 0.11 % of the data. We anticipate no difficulties in removing the single NA value from subsequent analyses. Non-independence is expected from repeated measurements of multiple herring that occurred within the same salmon stomach. Herring consumed at similar times of year may have similar growth trajectories that contribute to temporal autocorrelation. Spatial autocorrelation may occur if herring consumed in similar areas have similar prey fields and grow rates.

## D)
We will use the normal distribution for modelling. (140)

# Section 3: The Explanatory Variables
## A)
```{r, fig.width = 6, fig.height = 8, echo = FALSE}
#Make multipanel of dotcharts for continuous explanatory variables
par(mfrow = c(2, 2), mar = c(4, 4, 1, 1))

#Salmon length dotchart
with(herring_data, plot(sal.length, row, las = 1, type = "n", xlab = "Salmon length [cm]", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(sal.length, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Collection day of year dotchart
with(herring_data, plot(coll.doy, row, las = 1, type = "n", xlab = "Collection day of year", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(coll.doy, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Latitude dotchart
with(herring_data, plot(lat, row, las = 1, type = "n", xlab = "Latitude [°]", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(lat, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Longitude dotchart
with(herring_data, plot(long, row, las = 1, type = "n", xlab = "Longitude [°]", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(long, row, las = 1, type = "p", pch = 19, cex = 0.5))
```

```{r, fig.width = 10, fig.height = 7, echo = FALSE}
#Make multipanel of histograms for continuous explanatory variables
par(mfrow = c(2, 2))

#Salmon length histogram
hist(herring_data$sal.length, cex.main = 1.5, cex.lab = 1, cex.axis = 1, col = grey(0.9), breaks = seq(40, 100, by = 1), main = "Histogram of salmon length", xlab = "Salmon length [cm]")
rug(herring_data$sal.length)

#Collection day of year histogram
hist(herring_data$coll.doy, cex.main = 1.5, cex.lab = 1, cex.axis = 1, col = grey(0.9), breaks = seq(0, 400, by = 7), main = "Histogram of collection day of year", xlab = "Collection day of year")
rug(herring_data$coll.doy)

#Latitude histogram
hist(herring_data$lat, cex.main = 1.5, cex.lab = 1, cex.axis = 1, col = grey(0.9), breaks = seq(48.0, 51.0, by = 0.05), main = "Histogram of latitude", xlab = "Latitude [°]")
rug(herring_data$lat)

#Longitude histogram
hist(herring_data$long, cex.main = 1.5, cex.lab = 1, cex.axis = 1, col = grey(0.9), breaks = seq(-125.5, -123, by = 0.05), main = "Histogram of longitude", xlab = "Longitude [°]")
rug(herring_data$long)

```

```{r, fig.width = 10, fig.height = 5, echo = FALSE}
#Make multipanel for plots of categorical explanatory variables
par(mfrow = c(1, 2))

#Make dotchart of salmon id
with(herring_data, plot(sal.id, row, las = 1, type = "n", cex.lab = 1, cex.axis = 1, xlab = "Salmon ID", ylab = "Row Number"))
abline (h = seq(1, n, by = 5), col = "lightgrey")
with(herring_data, points(sal.id, row, las = 1, type = "p", pch = 19, cex = 0.5))

#Make a histogram of herring frequency per salmon
hist(herring_data$sal.id, col = grey(0.9), cex.main = 1.5, cex.lab = 1, cex.axis = 1, breaks = seq(17300, 18200, by = 1), main = "Histogram of Salmon ID", xlab = "Salmon ID")
```

## B)
One outlier is observed at 45cm and three outliers at 90 - 100cm. However, these are reasonable sizes for recreationally caught chinook salmon. No transformations are necessary as no substantial skewedness is observed. (32)

#Section 4: Collinearity, Balance, and Variance Inﬂation Factors
## A)
```{r, echo = TRUE, fig.width = 7, fig.height = 5.5, echo = FALSE}
#Create data frame of continuous explanatory variables for pairwise scatter plots
herring_collinearity <- data.frame("sal.length" = herring_data$sal.length,
    "coll.doy" = herring_data$coll.doy, "lat" = herring_data$lat, "long" = herring_data$long)

#Make pairwise scatterplot of explanatory variables
plot(herring_collinearity[1:4], cex = 0.5, pch = 19, col = rgb(0, 0, 0, 0.5), 
     labels = c("Chinook\nLength [cm]", "Collection\nDay in 2018", "Latitude [°]", "Longitude [°]"))
```

```{r, fig.width = 6, fig.height = 4, echo = FALSE}
#Plot mean salmon size vs. collection month
boxplot(sal.length ~ coll.month, data = herring_data, cex.main = 0.75, cex.lab = 0.75, cex.axis = 0.75, xlab = "Collection day of year", ylab = "Salmon length [cm]", main = "Boxplot of salmon size by collection month")
```

```{r}
#Calculate and view pairwise correlation coefficients for explanatory variables
print(cor(na.omit(herring_data[ ,c("sal.length", "coll.doy", "lat", "long")])), digits = 2)

#Calulate and view Variance Inflation Factors
print(vif(na.omit(herring_data[ ,c("sal.length", "coll.doy", "lat", "long")])))
```
  

The only categorical variable is salmon id and the range in the number of herring per salmon was 1 to 7, which will not confound any other categorical variables. We will model salmon id as a random effect to account unbalancing effects associated with salmon id on the continuous variables.
  
The boxplot of mean salmon length per month shows greater variance and summer samples where lengths overlap with those observed in earlier months of the year, likely due to unbalanced sampling effort contributing to the concave up shape observed in the pairwise scatterplot. The remaining relationships observed in the pairwise scatterplots were consistent with the pairwise correlation coefficients. Salmon length was moderately, positively correlated (0.449) with latitude but moderately, negatively correlated longitude (-0.3991). There was a strong, negative correlation (-0.8721) between latitude and longitude. VIF values of latitude (4.721313) and longitude (4.428887) were greater than 3 and strongly colinear, which is expected due to the geographical constraints of the Strait of Georgia and Juan de Fuca. We will run models with either latitude or longitude to avoid the confounding effects of including both variables in a single model. (197)  

# Section 5: Statistical Methods and Model Fitting

We will be using linear mixed-effects models using the R Package lme4 (Bates et al. 2015). We are assuming that otolith width (mm), our response variable, is normally distributed as suggested by a histogram of otolith width. We will model otolith width (mm) as function of salmon length (cm), day of year in 2018, latitude and longitude. Dotplots and histograms of these predictor variables show few missing values or outliers so the data from these variables can be used for modelling. There wasn't strong colinearity between predictor variables except for longitude and latitude, which we will not include in the same model. We have chosen to standardize our predictor variables as they were measured on vastly different scales. We will include a random intercept corresponding to individual salmon (salmon id) to avoid autocorrelation from non-independence of multiple herring that may occur in a single salmon or experimental unit. Ecologically, it is likely that multiple herring in one stomach have similar sizes if they travel in the same school targeted by an individual salmon. We have chosen a random intercept for salmon id because the number of levels is greater than 10 (Zuur et al. 2007). (196)

## Standardizing data for models
```{r}
#Add columns for standardized continuous explanatory variables ((x - mean)/ 1 sd)
herring_data$sal.length_standardized <- (herring_data$sal.length - mean(herring_data$sal.length))  / sd(herring_data$sal.length)
herring_data$coll.doy_standardized <- (herring_data$coll.doy - mean(herring_data$coll.doy)) / sd(herring_data$coll.doy)
herring_data$lat_standardized <- (herring_data$lat - mean(herring_data$lat)) / sd(herring_data$lat)
herring_data$long_standardized <- (herring_data$long - mean(herring_data$long)) / sd(herring_data$long)
```

## Creating linear mixed-effect models
```{r}
#Intercept-only model
model_0 <- lmer(oto.width ~ (1 | sal.id), data = herring_data)

#Models with one explanatory variable
model_1 <- lmer(oto.width ~ sal.length_standardized + (1 | sal.id), data = herring_data)

model_2 <- lmer(oto.width ~ coll.doy_standardized + (1 | sal.id), data = herring_data)

model_3 <- lmer(oto.width ~ lat_standardized + (1 | sal.id), data = herring_data)

model_4 <- lmer(oto.width ~ long_standardized + (1 | sal.id), data = herring_data)

#Models with two explanatory variables
model_5 <- lmer(oto.width ~ coll.doy_standardized + sal.length_standardized + (1 | sal.id), data = herring_data)

model_6 <- lmer(oto.width ~ coll.doy_standardized + long_standardized  + (1 | sal.id), data = herring_data)

model_7 <- lmer(oto.width ~ coll.doy_standardized + lat_standardized + (1 | sal.id), data = herring_data)

model_8 <- lmer(oto.width ~  sal.length_standardized + long_standardized + (1 | sal.id), data = herring_data)

model_9 <- lmer(oto.width ~  sal.length_standardized + lat_standardized + (1 | sal.id), data = herring_data)

#Models with three explanatory variables
model_10 <- lmer(oto.width ~ coll.doy_standardized + lat_standardized + sal.length_standardized + (1 | sal.id), data = herring_data)

model_11 <- lmer(oto.width ~ coll.doy_standardized + long_standardized + sal.length_standardized + (1 | sal.id), data = herring_data)

#Models with two explanatory variables and one interaction term
model_5i <- lmer(oto.width ~ coll.doy_standardized*sal.length_standardized + (1 | sal.id), data = herring_data)

model_6i <- lmer(oto.width ~ coll.doy_standardized*long_standardized  + (1 | sal.id), data = herring_data)

model_7i <- lmer(oto.width ~ coll.doy_standardized*lat_standardized + (1 | sal.id), data = herring_data)

model_8i <- lmer(oto.width ~  sal.length_standardized*long_standardized + (1 | sal.id), data = herring_data)

model_9i <- lmer(oto.width ~  sal.length_standardized*lat_standardized + (1 | sal.id), data = herring_data)

#Models with three explanatory variables and one interaction term
model_10l <- lmer(oto.width ~ coll.doy_standardized  + lat_standardized*sal.length_standardized + (1 | sal.id), data = herring_data)

model_11l <- lmer(oto.width ~ coll.doy_standardized + long_standardized*sal.length_standardized + (1 | sal.id), data = herring_data)

model_10c <- lmer(oto.width ~ coll.doy_standardized*sal.length_standardized + lat_standardized + (1 | sal.id), data = herring_data)

model_11c <- lmer(oto.width ~ coll.doy_standardized*sal.length_standardized + long_standardized + (1 | sal.id), data = herring_data)

#Models with three explanatory variables and two interaction terms
model_10cl <- lmer(oto.width ~ coll.doy_standardized*sal.length_standardized*lat_standardized + (1 | sal.id), data = herring_data)

model_11cl <- lmer(oto.width ~ coll.doy_standardized*sal.length_standardized*long_standardized + (1 | sal.id), data = herring_data)
```

# Section 6: Model Checking 
## Plotting otolith.width vs. models' explanatory variables
```{r,  fig.width = 10, fig.height = 7, echo = FALSE}
#Otolith width vs. longitude
oto_vs_long <- ggplot(herring_data) + theme_minimal() + geom_point(aes(long, oto.width), shape = 1) + geom_smooth(aes(long, oto.width), se = FALSE) + xlab("Longitude [°]") +  ylab("Otolith width [mm]") + scale_y_continuous(breaks = seq(0, 3, 0.5))

#Otolith width vs. coll.doy
oto_vs_coll.doy <- ggplot(herring_data) +  theme_minimal() + geom_point(aes(coll.doy, oto.width), shape = 1) + geom_smooth(aes(coll.doy, oto.width), se = FALSE) + xlab("Collection of day") + ylab("Otolith width [mm]") + scale_y_continuous(breaks = seq(0, 3, 0.5))

#Otolith width vs. sal.length
oto_vs_sal.length <- ggplot(herring_data) + theme_minimal() + geom_point(aes(sal.length, oto.width), shape = 1) + geom_smooth(aes(sal.length, oto.width), se = FALSE) + xlab("Salmon length [cm]") + ylab("Otolith width [mm]") + scale_y_continuous(breaks = seq(0, 3, 0.5))

grid.arrange(oto_vs_long, oto_vs_coll.doy, oto_vs_sal.length, nrow = 2)
```

## Plotting residuals for Model 11 and Model 6
```{r}
#Add Model 11 residuals and fitted values to data frame
herring_data$resid_11 <- resid(model_11) 
herring_data$fitted_11 <- predict(model_11, re.form = ~0)

#Add Model 6 residuals and fitted values to data frame
herring_data$resid_6 <- resid(model_6) 
herring_data$fitted_6 <- predict(model_6, re.form = ~0)
```

```{r, fig.width = 8, fig.height = 4, echo = FALSE}
#Plot Model 11 residuals versus fitted values (shown with a smoothing curve)
resid_vs_fitted_11 <- ggplot(herring_data) + theme_minimal() + geom_point(aes(fitted_11, resid_11), shape = 1) + geom_smooth(aes(fitted_11, resid_11), se = FALSE) + xlab("Fitted values for Model 11") + ylab("Residuals for Model 11")

#Plot Model 6 residuals versus fitted values (shown with a smoothing curve)
resid_vs_fitted_6 <- ggplot(herring_data) + theme_minimal() + geom_point(aes(fitted_6, resid_6), shape = 1) + geom_smooth(aes(fitted_6, resid_6), se = FALSE) + xlab("Residuals for Model 6") +  ylab("Fitted values for Model 6")

grid.arrange(resid_vs_fitted_11, resid_vs_fitted_6, nrow = 2)
```

```{r, fig.width = 10, fig.height = 10, echo = FALSE}
#Make multipanel of residual plots
par(mfrow = c(2, 2))

#Plot Model 11 histogram of residuals as probability density with rug marks and reference curve
hist(resid(model_11), breaks = seq(-0.6, 0.8, 0.05), cex.main = 1.5, cex.lab = 1, cex.axis = 1, prob = TRUE, col = "lightgrey", main = "Histogram of Model 11 residuals", xlab = "Model 11 residuals")
rug(resid(model_11))
sd_hat <- sd(resid(model_11))
curve(dnorm(x, sd = sd_hat), add = TRUE)

#Make quantile-quantile plot with reference line for Model 11
qqnorm(resid(model_11))
qqline(resid(model_11), col = "red")

#Plot Model 6 histogram of residuals as probability density with rug marks and reference curve
hist(resid(model_6), prob = TRUE, cex.main = 1.5, cex.lab = 1, cex.axis = 1, main = "Histogram of Model 6 residuals", breaks = seq(-0.6, 0.8, 0.05), xlab = "Model 6 residuals", col = "lightgrey")
rug(resid(model_6))
sd_hat <- sd(resid(model_6))
curve(dnorm(x, sd = sd_hat), add = TRUE)

#Make quantile-quantile plot with reference line for Model 6
qqnorm(resid(model_6))
qqline(resid(model_6), col = "red")
```

## Plotting random intercepts for Model 11 and Model 6
```{r, fig.width = 10, fig.height = 10, echo = FALSE}
#Make multipanel of residual plots
par(mfrow = c(2, 2))

#Make Model 11 quantile-quantile plot for checking if random intercepts are normally distributed
qqnorm(ranef(model_11)$sal.id[, "(Intercept)"])
qqline(ranef(model_11)$sal.id[, "(Intercept)"])

#Plot histogram of Model 11 residuals as probability density with rug marks and reference curve
ranef_int <- ranef(model_11)$sal.id[, "(Intercept)"]
hist(ranef_int, prob = TRUE, breaks = seq(-1, 0.8, 0.1), cex.main = 1.5, cex.lab = 1, cex.axis = 1, col = "lightgrey", main = "Histogram of random intercepts", xlab = "Random intercepts")
rug(ranef_int)
sd_hat_int <- sd(ranef_int)
curve(dnorm(x, sd = sd_hat_int), add = TRUE)

#Make quantile-quantile plot for checking whether the random intercept is normally distributed
qqnorm(ranef(model_6)$sal.id[, "(Intercept)"])
qqline(ranef(model_6)$sal.id[, "(Intercept)"])

#Plot histogram of residuals as probability density with rug marks and reference curve
ranef_int <- ranef(model_6)$sal.id[, "(Intercept)"]
hist(ranef_int, prob = TRUE, breaks = seq(-1.1, 0.7, 0.1), cex.main = 1.5, cex.lab = 1, cex.axis = 1, col = "lightgrey", main = "Histogram of random intercepts", xlab = "Random intercepts")
rug(ranef_int)
sd_hat_int <- sd(ranef_int)
curve(dnorm(x, sd = sd_hat_int), add = TRUE)
```

## Plottng Model 6 residuals vs. salmon length
```{r, fig.width = 8, fig.height = 4, echo = FALSE}
#Plot residuals vs. sal.length (shown with smoothing curve)
ggplot(herring_data) +  theme_minimal() + geom_point(aes(sal.length, resid_6), shape = 1) + geom_smooth(aes(sal.length, resid_6), se = FALSE) + xlab("Residuals for Model 6") + ylab("Salmon length [cm]")
```

## Plotting for spatial and temporal autocorrelation
```{r}
#Create column of standardized otolith widths ((x - mean)/ 1 sd)
herring_data$oto.width_standardized <- (herring_data$oto.width - mean(herring_data$oto.width)) / sd(herring_data$oto.width)
```

```{r, fig.width = 10, fig.height = 5, echo = FALSE}
#Generate acf plot of standardized otolith widths
acf(herring_data$oto.width_, las = 1, lag = 100, cex.main = 1.5, cex.lab = 1, cex.axis = 1, main = "Series for standardized otolith widths")
```

```{r, fig.width = 5, fig.height = 3, echo = FALSE}
#Create column of standardized otolith widths classified as above or below mean
herring_data$Sign <- as.character(sign(herring_data$oto.width_standardized))

#Create column of the magnitude of standardized otolith widths
herring_data$Magnitude <- abs(herring_data$oto.width_standardized)

#Generate bubble plot
lat_vs_long <- ggplot(herring_data) + theme_minimal() + geom_point(aes(long, lat, colour = Sign, size = Magnitude, shape = Sign)) + scale_colour_manual( values = c("1" = "darkorange", "-1" = "steelblue4", "0" = "black")) + scale_shape_manual(values = c("1" = 1, "-1" = 1, "0" = 19)) + coord_fixed() +  ggtitle("Bubble plot of standardized otolith width") + xlab("Longitude [°]") + ylab("Latitude [°]")
print(lat_vs_long)
```

Pairwise scatterplots suggest a nonlinear relationship between the response and predictor variables. ACF plot suggests temporal autocorrelation at short time lags ~ 10 days or less. Bubble plots indicate spatial autocorrelation and/or may reflect the spatial size distribution of herring. Model 11 histogram of residuals appear normal compared to the quantile-quantile plot suggesting a non-normal distribution. Residuals fall above the 1:1 line at high quantiles and below the 1:1 line at negative quantiles, suggesting slightly right-skewed residuals. The increase in spread of the Model 11 residuals versus fitted values suggests unequal variance. Residuals for the random intercept appear to fall below the 1:1 line at negative quantiles, suggesting a non-normal distribution of residuals. Model 6 of residuals and random intercept distribution show the same pattern as Model 11, violating assumptions of the linear model. The increase in variance and non-linear relationships indicate that the linear model is not plausible. Outliers may exist above 0.5 and below -40; however, they may just represent the upper and lower range of the data given the pattern of increasing variance. (181)

# Section 7: Model Summary, Conﬁdence Intervals and Model Comparison 
## Rewriting all models with REML= FALSE
```{r}
#Intercept-only model
model_0 <- lmer(oto.width ~ (1 | sal.id), data = herring_data, REML= FALSE)

#Models with one explanatory variable
model_1 <- lmer(oto.width ~ sal.length_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_2 <- lmer(oto.width ~ coll.doy_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_3 <- lmer(oto.width ~ lat_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_4 <- lmer(oto.width ~ long_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

#Models with two explanatory variables
model_5 <- lmer(oto.width ~ coll.doy_standardized + sal.length_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_6 <- lmer(oto.width ~ coll.doy_standardized + long_standardized  + (1 | sal.id), data = herring_data, REML= FALSE)

model_7 <- lmer(oto.width ~ coll.doy_standardized + lat_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_8 <- lmer(oto.width ~  sal.length_standardized + long_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_9 <- lmer(oto.width ~  sal.length_standardized + lat_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

#Models with three explanatory variables
model_10 <- lmer(oto.width ~ coll.doy_standardized + lat_standardized + sal.length_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_11 <- lmer(oto.width ~ coll.doy_standardized + long_standardized + sal.length_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

#Models with two explanatory variables and one interaction term
model_5i <- lmer(oto.width ~ coll.doy_standardized*sal.length_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_6i <- lmer(oto.width ~ coll.doy_standardized*long_standardized  + (1 | sal.id), data = herring_data, REML= FALSE)

model_7i <- lmer(oto.width ~ coll.doy_standardized*lat_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_8i <- lmer(oto.width ~  sal.length_standardized*long_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_9i <- lmer(oto.width ~  sal.length_standardized*lat_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

#Models with three explanatory variables and one interaction term
model_10l <- lmer(oto.width ~ coll.doy_standardized  + lat_standardized*sal.length_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_11l <- lmer(oto.width ~ coll.doy_standardized + long_standardized*sal.length_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_10c <- lmer(oto.width ~ coll.doy_standardized*sal.length_standardized + lat_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_11c <- lmer(oto.width ~ coll.doy_standardized*sal.length_standardized + long_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

#Models with three explanatory variables and two interaction terms
model_10cl <- lmer(oto.width ~ coll.doy_standardized*sal.length_standardized*lat_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

model_11cl <- lmer(oto.width ~ coll.doy_standardized*sal.length_standardized*long_standardized + (1 | sal.id), data = herring_data, REML= FALSE)

```

## Running the AIC
```{r}
#Calculate AIC values
AIC_out <- AIC(model_0, model_1, model_2, model_3, model_4, model_5, model_6, model_7, model_8, model_9, model_5i, model_6i, model_7i, model_8i, model_9i, model_10, model_11, model_10l, model_10c, model_11l, model_11c, model_10cl, model_11cl)

#Calculate delta AIC values
AIC_out$delta_AIC <- AIC_out$AIC - min(AIC_out$AIC)

#Show AIC table with weights
AICtab(model_0, model_1, model_2, model_3, model_4, model_5, model_6, model_7, model_8, model_9, model_5i, model_6i, model_7i, model_8i, model_9i, model_10, model_11, model_10l, model_10c, model_11l, model_11c, model_10cl, model_11cl, base = TRUE, weights = TRUE)
```

## Summarizing Model 11 and Model 6
```{r}
#Call coeﬃcient estimates for fixed effects of Model 11
fixef(model_11)

#Call variation within and between salmon.id of Model 11
VarCorr(model_11)

#Calculate conﬁdence intervals for coeﬃcient estimate of Model 11
confint(model_11)

#Call coeﬃcient estimates for fixed effects of Model 6
fixef(model_6)

#Call variation within and between salmon.id of Model 6
VarCorr(model_6)

#Calculate conﬁdence intervals for coeﬃcient estimate of Model 6
confint(model_6)
```

```{r, fig.width = 10, fig.height = 5, echo = FALSE}
#Rearrange data for a plot of coefficients with standard errors
#Make data frame for plot of coefficients
confint_fixed_11 <- as.data.frame(confint(model_11, parm = c("(Intercept)", "coll.doy_standardized", "long_standardized", "sal.length_standardized")))

##Compute profile confidence intervals for coefficient estimates
confint_fixed_11 <- as.data.frame(confint_fixed_11)
confint_fixed_11$term <- rownames(confint_fixed_11)
confint_fixed_11$estimate <- fixef(model_11)

##Plot confidence intervals for coefficient estimates
ggplot(confint_fixed_11) + theme_bw() + geom_point(aes(y = term, x = estimate), colour = "midnightblue") + geom_vline(xintercept = 0, linetype = "dotted", colour = "red") +  geom_errorbarh(aes(y = term, xmin = `2.5 %`, xmax = `97.5 %`), colour = "midnightblue", height = 0.3) + scale_y_discrete(labels = c("Intercept", "Collection \nDay of Year", "Longitude", "Salmon length")) + xlab("Estimate") +  ylab("") +  ggtitle("Coefficient Estimates for Model 11") + scale_x_continuous(breaks = seq(-0.5, 1.5, 0.25)) + theme(axis.text = element_text(size = 14, colour = "black"), plot.title = element_text(size = 16))
```
  
```{r, fig.width = 10, fig.height = 5, echo = FALSE}
#Rearrange data for a plot of coefficients with standard errors
#Make data frame for plot of coefficients
confint_fixed_6 <- as.data.frame(confint(model_6, parm = c("(Intercept)", "coll.doy_standardized", "long_standardized")))

##Compute profile confidence intervals for coefficient estimates
confint_fixed_6 <- as.data.frame(confint_fixed_6)
confint_fixed_6$term <- rownames(confint_fixed_6)
confint_fixed_6$estimate <- fixef(model_6)

##Plot confidence intervals for coefficent estimates
ggplot(confint_fixed_6) + theme_bw() +  geom_point(aes(y = term, x = estimate), colour = "midnightblue") + geom_vline(xintercept = 0, linetype = "dotted", colour = "red") +
  geom_errorbarh(aes(y = term, xmin = `2.5 %`, xmax = `97.5 %`), colour = "midnightblue", height = 0.3) + scale_y_discrete(labels = c("Intercept", "Collection \nDay of Year", "Longitude")) + xlab("Estimate") + ylab("") + ggtitle("Coefficient Estimates for Model 6") + scale_x_continuous(breaks = seq(-0.5, 1.5, 0.25)) + theme(axis.text = element_text(size = 14, colour = "black"), plot.title = element_text(size = 16))
```
  
# Section 8: Plotting a Model with the Data
## Visualizing Model 11
```{r, fig.width = 8, fig.height = 10, echo = FALSE}
#Create data frame for plot of Model 11 predictions with longitude on the x axis
oto.width_vs_long_data_11 <- data.frame(long = seq(-125.29, -123.16, 0.001), coll.doy_standardized = median(herring_data$coll.doy_standardized), sal.length_standardized = median(herring_data$sal.length_standardized))

#Add standardized long data to data frame
oto.width_vs_long_data_11$long_standardized <- ((oto.width_vs_long_data_11$long - mean(oto.width_vs_long_data_11$long))/sd(oto.width_vs_long_data_11$long))

#Generate model predictions at population level 
oto.width_vs_long_data_11$fit_11_pop <- predict(model_11, newdata = oto.width_vs_long_data_11, re.form = ~0)

#Generate model predictions at salmon id level
herring_data$fit_11_sal.id <- predict(model_11)

#Plot the model vs. longitude
model_11_long <- ggplot(herring_data) + theme_minimal() + geom_point(aes(long, oto.width), shape = 19, size = 1) +  geom_line(aes(long, fit_11_pop), data = oto.width_vs_long_data_11) + geom_point(aes(long, fit_11_sal.id, group = sal.id), shape = 3, colour = "lightcoral") + xlab("Longitude [°]") + ylab("Otolith width [mm]") + scale_y_continuous(breaks = seq(0, 3, 0.5))

#Create data frame for plot of Model 11 predictions with coll.doy on the x axis
oto.width_vs_coll.doy_data_11 <- data.frame(coll.doy = seq(1, 365, 1), long_standardized = median(herring_data$long_standardized), sal.length_standardized = median(herring_data$sal.length_standardized)) 

#Add standardized coll.doy data to data frame
oto.width_vs_coll.doy_data_11$coll.doy_standardized <- ((oto.width_vs_coll.doy_data_11$coll.doy - mean(oto.width_vs_coll.doy_data_11$coll.doy))/sd(oto.width_vs_coll.doy_data_11$coll.doy))

#Generate model predictions at population level 
oto.width_vs_coll.doy_data_11$fit_11_pop <- predict(model_11, newdata = oto.width_vs_coll.doy_data_11, re.form = ~0)

#Generate model predictions at salmon id level
herring_data$fit_11_sal.id <- predict(model_11)

#Plot the model vs.coll.doy
model_11_coll.doy <- ggplot(herring_data) + theme_minimal() + geom_point(aes(coll.doy, oto.width), shape = 19, size = 1) +  geom_line(aes(coll.doy, fit_11_pop), data = oto.width_vs_coll.doy_data_11) + geom_point(aes(coll.doy, fit_11_sal.id, group = sal.id), shape = 3, colour = "lightcoral") + xlab("Collection day of year") + ylab("Otolith width [mm]") + scale_y_continuous(breaks = seq(0, 3, 0.5))

#Create data frame for plot of Model 11 predictions with sal.length on the x axis
oto.width_vs_sal.length_data_11 <- data.frame(sal.length = seq(45, 96, 0.5), long_standardized = median(herring_data$long_standardized), coll.doy_standardized = median(herring_data$coll.doy_standardized))

#Add standardized sal.length data to data frame
oto.width_vs_sal.length_data_11$sal.length_standardized <- ((oto.width_vs_sal.length_data_11$sal.length - mean(oto.width_vs_sal.length_data_11$sal.length))/sd(oto.width_vs_sal.length_data_11$sal.length))

#Generate model predictions at population level 
oto.width_vs_sal.length_data_11$fit_11_pop <- predict(model_11, newdata = oto.width_vs_sal.length_data_11, re.form = ~0)

#Plot the model vs. sal.length
model_11_sal.length <- ggplot(herring_data) + theme_minimal() + geom_point(aes(sal.length, oto.width), shape = 19, size = 1) +  geom_line(aes(sal.length, fit_11_pop), data = oto.width_vs_sal.length_data_11) + geom_point(aes(sal.length, fit_11_sal.id, group = sal.id), shape = 3, colour = "lightcoral") + xlab("Salmon length [cm]") + ylab("Otolith width [mm]") + scale_y_continuous(breaks = seq(0, 3, 0.5))

grid.arrange(model_11_long, model_11_coll.doy, model_11_sal.length, nrow = 3)
```

## Visualizing Model 6
```{r, fig.width = 8, fig.height = 8, echo = FALSE}
#Create data frame for plot of Model 6 predictions with longitude on the x axis
oto.width_vs_long_data_6 <- data.frame(long = seq(-125.29, -123.16, 0.001), coll.doy_standardized = median(herring_data$coll.doy_standardized), sal.length_standardized = median(herring_data$sal.length_standardized))

#Add standardized long data to data frame
oto.width_vs_long_data_6$long_standardized <- ((oto.width_vs_long_data_6$long - mean(oto.width_vs_long_data_6$long))/sd(oto.width_vs_long_data_6$long))

#Generate model predictions at population level 
oto.width_vs_long_data_6$fit_6_pop <- predict(model_6, newdata = oto.width_vs_long_data_6, re.form = ~0)

#Generate model predictions at salmon id level
herring_data$fit_6_sal.id <- predict(model_6)

#Plot the model vs. longitude
model_6_long <- ggplot(herring_data) +  theme_minimal() + geom_point(aes(long, oto.width), shape = 19, size = 1) +  geom_line(aes(long, fit_6_pop), data = oto.width_vs_long_data_6) + geom_point(aes(long, fit_6_sal.id, group = sal.id), shape = 3, color = "lightcoral") + xlab("Longitude [°]") + ylab("Otolith width [mm]") + scale_y_continuous(breaks = seq(0, 3, 0.5))

#Create data frame for plot of Model 6 predictions with coll.doy on the x axis
oto.width_vs_coll.doy_data_6 <- data.frame(coll.doy = seq(1, 365, 1), long_standardized = median(herring_data$long_standardized), sal.length_standardized = median(herring_data$sal.length_standardized))

#Add standardized coll.doy data to data frame
oto.width_vs_coll.doy_data_6$coll.doy_standardized <- ((oto.width_vs_coll.doy_data_6$coll.doy - mean(oto.width_vs_coll.doy_data_6$coll.doy))/sd(oto.width_vs_coll.doy_data_6$coll.doy))

#Generate model predictions at population level 
oto.width_vs_coll.doy_data_6$fit_6_pop <- predict(model_6, newdata = oto.width_vs_coll.doy_data_6, re.form = ~0)

#Generate model predictions at salmon id level
herring_data$fit_6_sal.id <- predict(model_6)

#Plot the model vs.coll.doy
model_6_coll.doy <- ggplot(herring_data) + theme_minimal() + geom_point(aes(coll.doy, oto.width), shape = 19, size = 1) + geom_line(aes(coll.doy, fit_6_pop), data = oto.width_vs_coll.doy_data_6) + geom_point(aes(coll.doy, fit_6_sal.id, group = sal.id), shape = 3, color = "lightcoral") + xlab("Collection day of year") +  ylab("Otolith width [mm]") + scale_y_continuous(breaks = seq(0, 3, 0.5))

#Create data frame for plot of Model 6 predictions with sal.length on the x axis
oto.width_vs_sal.length_data_6 <- data.frame(sal.length = seq(45, 96, 0.5), long_standardized = median(herring_data$long_standardized), coll.doy_standardized = median(herring_data$coll.doy_standardized))

grid.arrange(model_6_long, model_6_coll.doy, nrow = 2)
```

# Section 9: Discussion
## A)
Model 11 and 6 does not fit the data well and violates linear model assumptions. Both models overpredict otolith width between longitude -124.0 to -125.0. Both models overpredict between 0 to 50 days and underpredict 125 to 175 days. Model 11 overpredicts for salmon between 40 cm to 60 cm.

## B)
Model 11 coefficient plot shows that salmon length has a small positive relationship with otolith width, but the confidence interval overlaps with 0 and is not a useful predictor unlike longitude and day of year that doesn’t overlap with 0 and has a small, negative relationship with otolith width. Similar patterns are observed for Model 6. The results support our hypothesis for a positive relationship between otolith width versus salmon length and longitude but contradicts positive relationship we hypothesized for collection day. Interestingly, longitude better describes otolith width than latitude so we determine that longitude and collection day of year best describe the variation in herring size consumed by Chinook Salmon in the Salish Sea in 2018.

## C)
Longitude is not capturing east-west patterns from shallow to deep water, but the spatial size distribution of herring in westerly regions near Comox Valley and easterly regions near San Juan Islands. Modelling capture location as a categorical variable will allow us to look at regional patterns. Otolith width versus collection day may represent two or more age classes of available herring. Modelling age classes separately may suggest the importance of a different set of factors. Alternatively, we could model herring size as a quadratic relationship. Otolith width versus salmon length shows few salmon below 62cm paired with model overprediction, due to gape limitation or size restrictions >62cm for recreational catch. Generating models with and without fish <62cm can determine whether omitting this subset is justified and changes our result.

## D)
The longitudinal and day of year pattern may reflect high herring abundance along east coast Vancouver Island and peak spawning near Hornby/Denman Island in mid-March (Therriault et al. 2009). Perhaps a greater contribution of large herring consumed in western regions and small larvae appearing in June are driving these trends. Although salmon length is a poor predictor, the overall trend suggests prey size range increases with salmon size, consistent with findings in other marine predators (Scharf et al. 2000). (385)


## References
Baptiste, A. (2017). gridExtra: Miscellaneous Functions for "Grid" Graphics. R package version 2.3. https://CRAN.R-project.org/package=gridExtra

Bates, D., Maechler, M., Bolker, B., Walker, S., 2015. Fitting Linear Mixed-Effects Models Using lme4.
Journal of Statistical Software, 67 (1), 1-48.

Bates, D., Maechler, M., Bolker, B. & Walker, S. (2015). Fitting Linear Mixed-Effects Models Using lme4. Journal of Statistical Software, 67(1), 1-48. doi:10.18637/jss.v067.i01.

Bolker, B. and R Development Core Team (2020). bbmle: Tools for General Maximum Likelihood Estimation. R package version 1.0.23.1. https://CRAN.R-project.org/package=bbmle

Faraway, J. (2016). faraway: Functions and Datasets for Books by Julian Faraway. R package version 1.0.7. https://CRAN.R-project.org/package=faraway

Scharf, F. S., F. Juanes, and R. A. Rountree. 2000. Predator size - Prey size relationships of marine fish predators: Interspecific variation and effects of ontogeny and body size on trophic-niche breadth. Marine Ecology Progress Series 208:229–248.

Schindler, D. E., M. D. Scheuerell, J. W. Moore, S. M. Gende, T. B. Francis, and W. J. Palen. 2003. Pacific Salmon and the Ecology of Coastal Ecosystems. Frontiers in Ecology and the Environment 1:31.

Stevenson, D. K., and S. E. Campana. 1992. Otolith microstructure examination and analysis. Can. Spec. Publ. Fish. Aquat. Sci. 117: 126 p. 1. Page Otolith Microstructure Examination and Analysis.

Therriault, T. W., D. E. Hay, and J. F. Schweigert. 2009. Biological overview and trends in pelagic forage fish abundance in the Salish Sea (Strait of Georgia, British Columbia). Marine Ornithology 37:3–8.

Wickham, H. (2011). The Split-Apply-Combine Strategy for Data Analysis. Journal of Statistical Software, 40(1), 1-29. URL  http://www.jstatsoft.org/v40/i01/.

Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686, https://doi.org/10.21105/joss.01686

Zuur, A., et al., 2007. Analysing Ecological Data. Springer: New York.
